<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CONTROLE DE VISITAS</title>
<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #f39c12;
        --success-color: #2ecc71;
        --danger-color: #e74c3c;
        --bg-color: #f4f6f8;
        --container-bg: #fff;
        --border-color: #e0e6ed;
        --bloco-bg: #f9fbfd;
    }

    body {
        font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 30px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        box-sizing: border-box;
        overflow-y: auto;
    }

    .main-container {
        background-color: var(--container-bg);
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        width: 95%;
        max-width: 1400px;
    }

    h1 { text-align: center; color: var(--primary-color); margin-bottom: 30px; font-size: 2em; }

    .button-bar { display: flex; justify-content: flex-start; gap: 20px; margin-bottom: 25px; }
    
    .button-bar.locked button:not(#btn-add) {
        pointer-events: none;
        opacity: 0.5;
        cursor: not-allowed;
    }

    button {
        font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        padding: 14px 24px;
        transition: background-color 0.3s ease, transform 0.1s ease;
        text-transform: uppercase;
    }
    button:active { transform: translateY(1px); }
    
    #btn-add { background-color: var(--secondary-color); color: #fff; }
    #btn-add:hover { background-color: #2980b9; }

    #btn-export { background-color: var(--success-color); color: #fff; }
    #btn-export:hover { background-color: #27ae60; }

    #btn-clear { background-color: var(--danger-color); color: #fff; }
    #btn-clear:hover { background-color: #c0392b; }

    /* Tabela */
    .data-table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; }
    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
        text-align: left;
        table-layout: fixed;
    }
    .data-table th, .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .data-table thead tr { background-color: var(--bloco-bg); color: var(--primary-color); text-transform: uppercase; }
    .data-table tbody tr:nth-of-type(even) { background-color: #f6f8fa; }

    /* Modal */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none; justify-content: center; align-items: center;
        z-index: 1000; overflow-y: auto;
    }
    .modal-content {
        background-color: var(--container-bg);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        width: 96%;
        max-width: 1100px;
        max-height: 95vh;
        position: relative; box-sizing: border-box;
        display: flex; flex-direction: column; align-items: center; gap: 20px;
    }
    .close-btn {
        position: absolute; top: 15px; right: 25px;
        font-size: 2.5em; font-weight: bold; color: #aaa; cursor: pointer; transition: color 0.2s;
    }
    .close-btn:hover { color: var(--danger-color); }

    /* Formulário */
    h2 { color: var(--secondary-color); font-size: 1.5em; margin-top: 0; width: 100%; }
    h3 { color: var(--primary-color); font-size: 1.2em; margin-bottom: 10px; }

    .form-group-wrapper { width: 100%; display: none; }
    .form-group { margin-bottom: 15px; width: 100%; }
    .form-inline { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }

    label { display: block; margin-bottom: 8px; color: var(--primary-color); font-weight: bold; font-size: 0.9em; }

    input[type="text"], input[type="tel"], textarea {
        font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
        border-radius: 6px; border: 1px solid #bdc3c7;
        padding: 12px; box-sizing: border-box; width: 100%;
        transition: all 0.3s ease;
    }
    input[type="text"]:focus, input[type="tel"]:focus, textarea:focus {
        border-color: var(--secondary-color); outline: none; box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
    }
    textarea { min-height: 100px; resize: vertical; }

    .form-button-container { margin-top: 10px; width: 100%; display: flex; justify-content: flex-end; gap: 10px; }
    #adicionar { background-color: var(--success-color) !important; }
    #finalizar { background-color: var(--secondary-color) !important; }

    /* Barra de Progresso */
    .progress-bar-container { margin-top: 30px; width: 100%; height: 10px; background-color: #e0e0e0; border-radius: 5px; overflow: hidden; }
    .progress-bar { height: 100%; background-color: var(--success-color); width: 0; transition: width 0.4s ease-in-out; }
    .progress-text { text-align: center; margin-top: 10px; font-size: 0.9em; color: var(--primary-color); }

    /* ===== BLOCO DO ENDEREÇO (lado a lado) ===== */
    .bloco-endereco {
        display: grid;
        grid-template-columns: 1fr 2fr 2fr 1fr;
        gap: 16px;
        width: 100%;
    }
    .bloco-endereco .full-width { grid-column: 1 / -1; }

    /* Responsivo */
    @media (max-width: 800px) { .bloco-endereco { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 560px) { .bloco-endereco { grid-template-columns: 1fr; } .modal-content { width: 98%; max-width: 100%; } }

    .copyright {
        font-size: 10px;
        color: #fff;
        text-align: center;
        margin-top: 20px;
        background-color: #2c3e50;
        padding: 10px;
        border-radius: 5px;
        width: 100%;
        box-sizing: border-box;
    }
</style>
</head>
<body>

<div class="main-container">
    <h1>CONTROLE DE AGENDAMENTOS DE VISITA</h1>

    <div class="button-bar locked">
        <button id="btn-add">Adicionar Visita</button>
        <button id="btn-export">Exportar para Excel</button>
        <button id="btn-clear">Limpar Tabela</button>
    </div>

    <h3>Últimos Agendamentos</h3>
    <div class="data-table-container">
        <table class="data-table" id="dataTable">
            <thead>
                <tr>
                    <th>Data de Inclusão</th>
                    <th>Nome</th>
                    <th>CPF</th>
                    <th>Contato</th>
                    <th>CEP</th>
                    <th>Rua / Av. / Trav. / Al.</th>
                    <th>Localidade / Bairro</th>
                    <th>Número</th>
                    <th>Finalidade</th>
                    <th>Entrevistador</th>
                    <th>CPF (Entrevistador)</th>
                    <th>Status da Visita</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div class="copyright">
    © 2025 - Todos os direitos reservados a Renan Santana Ortiz
</div>

<div id="formModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" title="Fechar">&times;</span>
        <h1>CADASTRO DE SOLICITAÇÃO DE VISITA</h1>

        <form id="formCadastro">
            <div class="form-group-wrapper" id="fg-nome">
                <h2>Solicitante</h2>
                <div class="form-group">
                    <label for="nome">Nome RUF:</label>
                    <input type="text" id="nome" autofocus>
                </div>
            </div>

            <div class="form-group-wrapper" id="fg-cpf">
                <div class="form-group">
                    <label for="cpf">CPF:</label>
                    <input type="text" id="cpf" maxlength="14">
                </div>
            </div>

            <div class="form-group-wrapper" id="fg-contato1">
                <div class="form-group">
                    <label for="contato1">Contato 1:</label>
                    <input type="tel" id="contato1" maxlength="15">
                </div>
            </div>

            <div class="form-group-wrapper" id="fg-contato2">
                <div class="form-group">
                    <label for="contato2">Contato 2:</label>
                    <input type="tel" id="contato2" maxlength="15">
                </div>
            </div>

            <div class="form-group-wrapper" id="fg-contato3">
                <div class="form-group">
                    <label for="contato3">Contato 3:</label>
                    <input type="tel" id="contato3" maxlength="15">
                </div>
            </div>

            <div class="form-group-wrapper" id="fg-cep">
                <h2>Endereço</h2>
                <div class="form-group">
                    <div class="bloco-endereco">
                        <div class="form-group">
                            <label for="cep">CEP:</label>
                            <div class="form-inline">
                                <input type="text" id="cep" maxlength="9" placeholder="00000-000">
                                <button type="button" id="buscarCep">Buscar CEP</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="rua">Rua / Av. / Trav. / Al.:</label>
                            <input type="text" id="rua" disabled>
                        </div>
                        <div class="form-group">
                            <label for="bairro">Localidade / Bairro:</label>
                            <input type="text" id="bairro" disabled>
                        </div>
                        <div class="form-group">
                            <label for="numero">Número:</label>
                            <input type="text" id="numero">
                        </div>
                        <div class="form-group full-width">
                            <label for="complemento">Complemento:</label>
                            <input type="text" id="complemento">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group-wrapper" id="fg-motivo">
                <h2>Finalidade</h2>
                <div class="radio-group" id="finalidadeRadios">
                    <label><input type="radio" name="motivo" value="1|Família Unipessoal - Beneficiária de PBF"> 1 - Família Unipessoal - Beneficiária de PBF</label>
                    <label><input type="radio" name="motivo" value="2|Família Unipessoal - Beneficiária de BPC"> 2 - Família Unipessoal - Beneficiária de BPC</label>
                    <label><input type="radio" name="motivo" value="3|Família Unipessoal - Que deseja acessar PBF"> 3 - Família Unipessoal - Que deseja acessar PBF</label>
                    <label><input type="radio" name="motivo" value="4|Família Unipessoal - Que deseja acessar BPC"> 4 - Família Unipessoal - Que deseja acessar BPC</label>
                    <label><input type="radio" name="motivo" value="5|Família que deseja excluir membro com renda migrada CNIS"> 5 - Família que deseja excluir membro com renda migrada CNIS</label>
                    <label>
                        <input type="radio" name="motivo" value="6|Outro motivo">
                        6 - Outro motivo, especifique:
                    </label>
                    <div class="form-group" id="outroMotivoBox" style="display:none; margin-top:8px;">
                        <textarea id="outroMotivo" placeholder="Descreva o motivo"></textarea>
                    </div>
                </div>

                <div id="motivo5-extra" style="display:none; margin-top:10px;">
                    <h3>Dados para exclusão de membro (<span id="m5-count">0</span> adicionado(s)):</h3>
                    <div class="bloco-endereco" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label for="m5_nome">Nome:</label>
                            <input type="text" id="m5_nome">
                        </div>
                        <div class="form-group">
                            <label for="m5_cpf">CPF:</label>
                            <input type="text" id="m5_cpf" maxlength="14">
                        </div>
                        <div class="form-group">
                            <label for="m5_nis">NIS:</label>
                            <input type="text" id="m5_nis" maxlength="11">
                        </div>
                    </div>
                    <small style="color:#7f8c8d;">Preencha pelo menos 2 campos acima.</small>
                    <button type="button" id="add-membro" style="margin-top: 10px;">Adicionar Membro</button>
                </div>
            </div>

            <div class="form-button-container">
                <button type="button" id="adicionar" style="display: none;">ADICIONAR</button>
                <button type="button" id="finalizar" style="display: none;">FINALIZAR</button>
            </div>
        </form>

        <div class="progress-bar-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progressText" class="progress-text"></div>
    </div>
</div>

<script>
    // ================== Estado Global ==================
    let visitasAdicionadas = 0;
    const dadosColetados = [];
    let membrosExcluir = [];
    const formState = {
        currentFieldIndex: 0,
        entrevistadorNome: '',
        entrevistadorCpf: '',
        contactCount: 1,
        operadorRegistrado: false
    };

    const fieldOrder = [
        'nome', 'cpf', 'contato1', 'contato2', 'contato3',
        'cep', 'rua', 'bairro', 'numero', 'complemento',
        'motivo'
    ];

    // ================== Utilitários ==================
    function capitalizeName(name) {
        if (!name) return '';
        return name.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    function onlyDigits(s){ return (s||'').replace(/\D/g,''); }

    function formatCPF(cpf) {
        const s = onlyDigits(cpf);
        return s.replace(/(\d{0,3})(\d{0,3})(\d{0,3})(\d{0,2})/, (_,a,b,c,d) =>
            [a,b,c].filter(Boolean).join('.') + (d ? '-' + d : '')
        );
    }
    function formatPhone(phone) {
        const s = onlyDigits(phone);
        return s.replace(/(\d{0,2})(\d{0,5})(\d{0,4})/, (_,a,b,c) =>
            (a ? '('+a+')' : '') + (b||'') + (c ? '-'+c : '')
        );
    }
    function formatCEP(cep) {
        const s = onlyDigits(cep);
        return s.replace(/(\d{0,5})(\d{0,3})/, (_,a,b)=> a + (b ? '-'+b : ''));
    }

    function removeAcentos(texto) {
        if (!texto) return '';
        return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ç/g, "c");
    }

    function validateField(fieldId, value) {
        if (fieldId === 'nome' && !value.trim()) { alert('Por favor, preencha o nome.'); return false; }
        if (fieldId === 'cpf' && onlyDigits(value).length < 11) { alert('Por favor, preencha o CPF com 11 dígitos.'); return false; }
        if (fieldId.startsWith('contato') && onlyDigits(value).length < 11) { alert('Por favor, preencha o contato com 11 dígitos.'); return false; }
        return true;
    }

    // ================== Exibição de Campos ==================
    const addressSet = new Set(['cep', 'rua', 'bairro', 'numero', 'complemento']);

    function showField(index) {
        document.querySelectorAll('.form-group-wrapper').forEach(w => w.style.display = 'none');
        const currentId = fieldOrder[index];

        if (addressSet.has(currentId)) {
            document.getElementById('fg-cep').style.display = 'block';
        } else {
            const wrapper = document.getElementById(`fg-${currentId}`);
            if (wrapper) wrapper.style.display = 'block';
        }

        let focusId = currentId;
        if (currentId === 'rua' || currentId === 'bairro') focusId = 'numero';
        const el = document.getElementById(focusId);
        if (el && !el.disabled) el.focus();

        formState.currentFieldIndex = index;

        const onFinalidade = currentId === 'motivo';
        document.getElementById('adicionar').style.display = onFinalidade ? 'block' : 'none';
        document.getElementById('finalizar').style.display = onFinalidade ? 'block' : 'none';

        updateProgressBar();
    }

    function updateProgressBar() {
        const total = fieldOrder.length;
        const progress = (formState.currentFieldIndex / total) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;

        const nome = document.getElementById('nome').value;
        document.getElementById('progressText').textContent = nome ? `Cadastrando: ${capitalizeName(nome)}` : '';
    }

    // ================== Navegação (Enter/Tab/Esc) ==================
    document.addEventListener('keydown', async (e) => {
        if (!formState.operadorRegistrado) return;

        const activeElement = document.activeElement;

        if (e.key === 'Escape') {
            if (dadosColetados.length > 0) {
                finalizarAgendamentosAdicionados();
            } else {
                const confirmCancel = confirm("Você deseja cancelar o cadastramento?");
                if (confirmCancel) resetAndCloseForm();
            }
            return;
        }

        if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
            const currentId = activeElement.id || '';
            const value = activeElement.value || '';

            if (e.key === 'Enter') {
                e.preventDefault();

                if (currentId === 'cep') {
                    const cep = onlyDigits(value);
                    if (cep.length === 8) {
                        await buscarCepENavegar(cep);
                    } else {
                        alert("CEP inválido! Digite 8 dígitos.");
                        activeElement.focus();
                    }
                    return;
                }

                if (!validateField(currentId, value)) return;
                if (currentId === 'nome') activeElement.value = capitalizeName(value);
                if (currentId === 'cpf') activeElement.value = formatCPF(value);
                if (currentId.startsWith('contato')) activeElement.value = formatPhone(value);
                if (currentId === 'complemento' || currentId === 'outroMotivo') activeElement.value = value.toUpperCase();

                if (currentId.startsWith('contato') && onlyDigits(value).length === 11) {
                    if (formState.contactCount < 3) {
                        const addMore = confirm(`Você preencheu o Contato ${formState.contactCount}. Deseja adicionar mais um contato? (OK para SIM, Cancelar para NÃO)`);
                        if (addMore) {
                            formState.contactCount++;
                            const nextIndex = fieldOrder.indexOf(currentId) + 1;
                            showField(nextIndex);
                            return;
                        } else {
                            showField(fieldOrder.indexOf('cep'));
                            document.getElementById('cep').focus();
                            return;
                        }
                    }
                }

                const nextIndex = fieldOrder.indexOf(currentId) + 1;
                if (nextIndex < fieldOrder.length) showField(nextIndex);

            } else if (e.key === 'Tab') {
                if (currentId.startsWith('contato') && onlyDigits(activeElement.value).length === 11) {
                    if (formState.contactCount < 3) {
                        const addMore = confirm(`Você preencheu o Contato ${formState.contactCount}. Deseja adicionar mais um contato?`);
                        if (addMore) {
                            formState.contactCount++;
                            const nextIndex = fieldOrder.indexOf(currentId) + 1;
                            showField(nextIndex);
                            e.preventDefault();
                            return;
                        }
                    }
                }
            }
        } else if (e.key === 'Enter') {
            const currentId = (activeElement && activeElement.id) || '';
            if (currentId === 'adicionar' || currentId === 'finalizar') {
                e.preventDefault();
                activeElement.click();
            }
        }
    });

    // ================== Eventos de UI ==================
    document.getElementById('btn-add').addEventListener('click', (e) => {
        if (e.ctrlKey) {
            const registrar = confirm("Deseja registrar um operador para a sessão? (Os dados serão salvos automaticamente em todos os agendamentos)");
            if (registrar) {
                const nome = prompt("Digite o nome do operador:");
                const cpf = prompt("Digite o CPF do operador (somente números):");
                if (nome && cpf) {
                    formState.entrevistadorNome = capitalizeName(nome);
                    formState.entrevistadorCpf = formatCPF(cpf);
                    formState.operadorRegistrado = true;
                    document.querySelector('.button-bar').classList.remove('locked');
                    alert(`Operador ${formState.entrevistadorNome} registrado com sucesso. A sessão está liberada.`);
                } else {
                    alert("Nome ou CPF inválidos. A sessão não foi liberada.");
                }
            } else {
                formState.operadorRegistrado = true; // Libera sem registrar, mas a cada finalização pedirá os dados
                document.querySelector('.button-bar').classList.remove('locked');
                alert("A sessão está liberada. Você precisará digitar o nome e CPF do entrevistador para cada agendamento.");
            }
            return;
        }

        if (!formState.operadorRegistrado) {
            alert("A aplicação está bloqueada. Segure CTRL e clique em 'Adicionar Visita' para registrar um operador e liberar a sessão.");
            return;
        }

        document.getElementById('formModal').style.display = 'flex';
        showField(0);
    });
    
    document.querySelector('.close-btn').addEventListener('click', () => {
        const confirmCancel = confirm("Você deseja cancelar o cadastramento?");
        if (confirmCancel) resetAndCloseForm();
    });
    
    document.getElementById('btn-export').addEventListener('click', exportTableToExcel);
    document.getElementById('btn-clear').addEventListener('click', clearTable);

    // Máscaras e Formatações
    document.getElementById('cep').addEventListener('input', (e) => e.target.value = formatCEP(e.target.value));
    document.getElementById('cpf').addEventListener('input', (e) => e.target.value = formatCPF(e.target.value));
    ['contato1','contato2','contato3'].forEach(id => {
        document.getElementById(id).addEventListener('input', (e) => e.target.value = formatPhone(e.target.value));
    });
    document.getElementById('m5_cpf').addEventListener('input', (e)=> e.target.value = formatCPF(e.target.value));
    document.getElementById('nome').addEventListener('blur', (e) => { e.target.value = capitalizeName(e.target.value); });
    document.getElementById('m5_nome').addEventListener('blur', (e) => { e.target.value = capitalizeName(e.target.value); });

    // Botão "Buscar CEP"
    document.getElementById('buscarCep').addEventListener('click', async () => {
        const s = onlyDigits(document.getElementById('cep').value);
        if (s.length !== 8) {
            alert("CEP inválido! Digite 8 dígitos.");
            document.getElementById('cep').focus();
            return;
        }
        await buscarCepENavegar(s);
    });

    async function buscarCepENavegar(cepLimpo) {
        try {
            const res = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
            const data = await res.json();
            if (!data.erro) {
                document.getElementById('rua').value = data.logradouro || '';
                document.getElementById('bairro').value = data.bairro || '';
                const numeroEl = document.getElementById('numero');
                if (numeroEl) numeroEl.focus();
            } else {
                alert("CEP não encontrado!");
                document.getElementById('cep').focus();
            }
        } catch (err) {
            alert("Erro ao buscar CEP!");
            document.getElementById('cep').focus();
        }
    }

    // Mostrar/ocultar extras na Finalidade
    function handleMotivoExtras() {
        const selected = document.querySelector('input[name="motivo"]:checked');
        const val = selected ? selected.value.split('|')[0] : '';
        document.getElementById('outroMotivoBox').style.display = (val === '6') ? 'block' : 'none';
        document.getElementById('motivo5-extra').style.display = (val === '5') ? 'block' : 'none';
        
        if (val !== '5') {
            membrosExcluir = [];
            updateMembrosExcluirCount();
        }
    }
    document.getElementById('finalidadeRadios').addEventListener('change', handleMotivoExtras);

    // Botão Adicionar Membro
    document.getElementById('add-membro').addEventListener('click', () => {
        const nome = document.getElementById('m5_nome').value;
        const cpf = document.getElementById('m5_cpf').value;
        const nis = document.getElementById('m5_nis').value;

        if (!nome && !cpf && !nis) {
            alert("Preencha pelo menos um campo para adicionar.");
            return;
        }
        
        membrosExcluir.push({ nome: capitalizeName(nome), cpf: formatCPF(cpf), nis: onlyDigits(nis) });
        updateMembrosExcluirCount();
        
        document.getElementById('m5_nome').value = '';
        document.getElementById('m5_cpf').value = '';
        document.getElementById('m5_nis').value = '';
    });

    function updateMembrosExcluirCount() {
        document.getElementById('m5-count').textContent = membrosExcluir.length;
    }

    // ================== Ações de Formulário ==================
    document.getElementById('adicionar').addEventListener('click', () => {
        if (!validarFinalidade()) return;

        const dados = collectData();
        dadosColetados.push(dados);
        visitasAdicionadas++;
        alert("Agendamento adicionado à lista (ainda não foi para a tabela).");
        resetForm();
        showField(0);
    });

    document.getElementById('finalizar').addEventListener('click', async () => {
        if (!validarFinalidade()) return;
        
        const dadosAtuais = collectData();
        dadosColetados.push(dadosAtuais);
        visitasAdicionadas++;

        let nomeEntrevistador = formState.entrevistadorNome;
        let cpfEntrevistador = formState.entrevistadorCpf;
        
        if (!formState.entrevistadorNome) {
            nomeEntrevistador = prompt("Por favor, digite o nome do ENTREVISTADOR:");
            cpfEntrevistador = prompt("Por favor, digite o CPF do ENTREVISTADOR (somente números):");
            nomeEntrevistador = capitalizeName(nomeEntrevistador || '');
            cpfEntrevistador = formatCPF(cpfEntrevistador || '');
        }

        if (!nomeEntrevistador || !cpfEntrevistador) {
            alert("Nome ou CPF do entrevistador são obrigatórios para finalizar.");
            return;
        }

        dadosColetados.forEach(dados => {
            addDadosToTable(dados, nomeEntrevistador, cpfEntrevistador, "AGUARDANDO VISITA");
        });

        alert(`Cadastro finalizado!\n${visitasAdicionadas} visita(s) adicionada(s) com sucesso.`);

        resetAndCloseForm();
    });

    function validarFinalidade() {
        const sel = document.querySelector('input[name="motivo"]:checked');
        if (!sel) { alert("Selecione uma Finalidade."); return false; }

        const [num, texto] = sel.value.split('|');

        if (num === '6') {
            const outro = (document.getElementById('outroMotivo').value || '').trim();
            if (!outro) { alert("Descreva o motivo (opção 6)."); return false; }
        }

        if (num === '5') {
            if (membrosExcluir.length === 0) {
                alert("Para a opção 5, adicione pelo menos um membro.");
                return false;
            }
        }
        return true;
    }

    function collectData() {
        const sel = document.querySelector('input[name="motivo"]:checked');
        let finalidadeNum = '', finalidadeTexto = '';
        if (sel) { [finalidadeNum, finalidadeTexto] = sel.value.split('|'); }

        let finalidadeComMembros = finalidadeTexto;
        if (finalidadeNum === '5' && membrosExcluir.length > 0) {
            const membrosTexto = membrosExcluir.map(m => {
                const partes = [];
                if (m.nome) partes.push(`Nome: ${m.nome}`);
                if (m.cpf) partes.push(`CPF: ${m.cpf}`);
                if (m.nis) partes.push(`NIS: ${m.nis}`);
                return partes.join(' | ');
            }).join('; ');
            finalidadeComMembros += ` - Membros a excluir: ${membrosTexto}`;
        }
        
        const contatos = [
            document.getElementById('contato1').value, 
            document.getElementById('contato2').value, 
            document.getElementById('contato3').value
        ].filter(v => v).join(', ');

        return {
            nome: capitalizeName(document.getElementById('nome').value),
            cpf: formatCPF(document.getElementById('cpf').value),
            contatos: contatos,
            cep: document.getElementById('cep').value,
            bairro: document.getElementById('bairro').value,
            rua: document.getElementById('rua').value,
            numero: document.getElementById('numero').value,
            complemento: (document.getElementById('complemento').value || '').toUpperCase(),
            finalidade: finalidadeComMembros,
            finalidadeNum: finalidadeNum,
            outroMotivo: (document.getElementById('outroMotivo').value || '').toUpperCase(),
        };
    }

    function resetForm() {
        document.getElementById('formCadastro').reset();
        formState.contactCount = 1;
        document.getElementById('outroMotivoBox').style.display = 'none';
        document.getElementById('motivo5-extra').style.display = 'none';
        membrosExcluir = [];
        updateMembrosExcluirCount();
        updateProgressBar();
    }

    function resetAndCloseForm() {
        resetForm();
        document.getElementById('formModal').style.display = 'none';
        document.getElementById('progressText').textContent = '';
        updateProgressBar();
        visitasAdicionadas = 0;
        dadosColetados.length = 0;
    }

    // ================== Tabela ==================
    function addDadosToTable(d, entrevistadorNome, entrevistadorCpf, status) {
        const tbody = document.querySelector('#dataTable tbody');
        const tr = document.createElement('tr');
        const dataHora = new Date().toLocaleDateString('pt-BR');

        tr.innerHTML = `
            <td>${dataHora}</td>
            <td>${d.nome}</td>
            <td>${d.cpf}</td>
            <td>${d.contatos}</td>
            <td>${d.cep}</td>
            <td>${d.rua}</td>
            <td>${d.bairro}</td>
            <td>${d.numero}</td>
            <td>${d.finalidade}</td>
            <td>${entrevistadorNome || ''}</td>
            <td>${entrevistadorCpf || ''}</td>
            <td>${status}</td>
        `;
        tbody.appendChild(tr);
    }
    
    // ================== Exportar e Limpar ==================
    function exportTableToExcel() {
        if (!formState.operadorRegistrado) {
            alert("A aplicação está bloqueada. Segure CTRL e clique em 'Adicionar Visita' para registrar um operador e liberar a sessão.");
            return;
        }

        const tabela = document.getElementById("dataTable");
        const header = Array.from(tabela.querySelectorAll('thead th')).map(th => removeAcentos(th.textContent.trim()));
        const rows = Array.from(tabela.querySelectorAll('tbody tr')).map(tr => {
            const cells = Array.from(tr.querySelectorAll('td'));
            return cells.map(td => removeAcentos(td.textContent.trim()));
        });
        
        const columnWidths = [15, 30, 15, 16, 10, 20, 20, 12, 35, 20, 20, 20];

        let xml = `
            <?xml version="1.0" encoding="UTF-8"?>
            <Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
                      xmlns:o="urn:schemas-microsoft-com:office:office"
                      xmlns:x="urn:schemas-microsoft-com:office:excel"
                      xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
                      xmlns:html="http://www.w3.org/TR/REC-html40">
                <DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">
                    <Author>Documento gerado por script</Author>
                    <Created>${new Date().toISOString()}</Created>
                </DocumentProperties>
                <Styles>
                    <Style ss:ID="sHeader">
                        <Font ss:FontName="Arial Rounded MT Bold" x:Family="Swiss" ss:Size="12" ss:Color="#FFFFFF" ss:Bold="1"/>
                        <Alignment ss:Horizontal="Center" ss:Vertical="Center" ss:WrapText="1"/>
                        <Interior ss:Color="#7a7a7a" ss:Pattern="Solid"/>
                    </Style>
                    <Style ss:ID="sBody">
                        <Font ss:FontName="Arial Rounded MT Bold" x:Family="Swiss" ss:Size="10" ss:Color="#000000"/>
                        <Alignment ss:Horizontal="Center" ss:Vertical="Center" ss:WrapText="1"/>
                    </Style>
                </Styles>
                <Worksheet ss:Name="Agendamentos">
                    <Table>
        `;

        for (let i = 0; i < columnWidths.length; i++) {
            xml += `<Column ss:AutoFitWidth="0" ss:Width="${columnWidths[i] * 5.5}"/>`;
        }
        
        xml += `<Row ss:Height="36">`;
        header.forEach(h => {
            xml += `<Cell ss:StyleID="sHeader"><Data ss:Type="String">${h}</Data></Cell>`;
        });
        xml += `</Row>`;

        rows.forEach(row => {
            xml += `<Row ss:AutoFitHeight="1">`;
            row.forEach(cell => {
                xml += `<Cell ss:StyleID="sBody"><Data ss:Type="String">${cell}</Data></Cell>`;
            });
            xml += `</Row>`;
        });

        xml += `
                    </Table>
                    <WorksheetOptions xmlns="urn:schemas-microsoft-com:office:excel">
                        <PageSetup>
                            <Layout x:Orientation="Landscape"/>
                        </PageSetup>
                    </WorksheetOptions>
                </Worksheet>
            </Workbook>
        `;

        const data_type = 'data:application/vnd.ms-excel;charset=utf-8;base64,';
        const a = document.createElement('a');
        const nomeArquivo = 'agendamentos_' + new Date().toLocaleDateString('pt-BR').replace(/\//g, '-') + '.xls';
        
        a.href = data_type + btoa(unescape(encodeURIComponent(xml)));
        a.download = nomeArquivo;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        clearTable(false); // Mantém a tabela sem limpar os dados.
    }

    function clearTable(showConfirm = true) {
        if (!formState.operadorRegistrado) {
            alert("A aplicação está bloqueada. Segure CTRL e clique em 'Adicionar Visita' para registrar um operador e liberar a sessão.");
            return;
        }

        const confirmClear = showConfirm ? confirm("Tem certeza que deseja limpar todos os dados da tabela? Essa ação é irreversível.") : true;
        if (confirmClear) {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            if (showConfirm) {
              alert("Tabela limpa com sucesso.");
            }
        }
    }
</script>
</body>
</html>